---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import { getPostBySlug } from "../../lib/blog";

const { slug } = Astro.params;
const post = await getPostBySlug(slug!);

if (!post) {
  return Astro.redirect("/blog");
}

const publishedDate = post.createdAt?.toDate?.()?.toISOString?.() || new Date().toISOString();
const updatedDate = post.updatedAt?.toDate?.()?.toISOString?.() || publishedDate;

const postOgImage = post.coverImage || "https://sarvaseo.atrey.dev/sarvaseo-og.png";

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt,
  image: postOgImage,
  author: {
    "@type": "Person",
    name: post.author,
  },
  publisher: {
    "@type": "Organization",
    name: "SarvaSEO",
    url: "https://sarvaseo.atrey.dev/",
  },
  datePublished: publishedDate,
  dateModified: updatedDate,
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://sarvaseo.atrey.dev/blog/${post.slug}`,
  },
  keywords: post.tags?.join(", ") || "",
};
---

<Layout
  title={`${post.title} | SarvaSEO Blog`}
  description={post.excerpt || post.title}
  canonicalUrl={`https://sarvaseo.atrey.dev/blog/${post.slug}`}
  ogType="article"
  ogImage={postOgImage}
>
  <main class="max-w-3xl mx-auto px-6 py-16">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <article>
      <header class="mb-10">
        {post.coverImage && (
          <img
            src={post.coverImage}
            alt={post.title}
            class="w-full rounded-lg mb-6"
            width="1200"
            height="630"
            loading="eager"
          />
        )}
        <h1 class="font-instrument text-3xl sm:text-4xl text-gray-900 font-light mb-4">
          {post.title}
        </h1>
        <div class="flex items-center gap-3 text-xs text-gray-400">
          <span>{post.author}</span>
          <span>&middot;</span>
          <time datetime={publishedDate}>
            {post.createdAt?.toDate?.().toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            }) || ""}
          </time>
          {post.tags?.length > 0 && (
            <>
              <span>&middot;</span>
              <span>{post.tags.join(", ")}</span>
            </>
          )}
        </div>
      </header>

      <div class="blog-content" set:html={post.content} />
    </article>

    <div class="mt-12 pt-6 border-t border-gray-100">
      <a href="/blog" class="text-sm text-gray-500 hover:text-gray-700 underline">&larr; Back to Blog</a>
    </div>
  </main>
  <Footer />

  <div class="reading-bar" id="reading-bar"></div>

  <script is:inline>
    (function() {
      var bar = document.getElementById('reading-bar');
      if (!bar) return;
      window.addEventListener('scroll', function() {
        var h = document.documentElement.scrollHeight - window.innerHeight;
        if (h > 0) bar.style.width = (window.scrollY / h * 100) + '%';
      }, { passive: true });
    })();
  </script>
</Layout>

<style>
  .reading-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 3px;
    background: linear-gradient(90deg, #9a6e24, #d4a843, #edd06b);
    z-index: 9999;
    transition: width 0.1s linear;
  }

  .blog-content :global(h2) {
    font-family: "Instrument Serif", Georgia, "Times New Roman", serif;
    font-size: 1.5rem;
    color: #111827;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .blog-content :global(h3) {
    font-family: "Instrument Serif", Georgia, "Times New Roman", serif;
    font-size: 1.25rem;
    color: #111827;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .blog-content :global(p) {
    font-size: 0.9375rem;
    line-height: 1.75;
    color: #374151;
    margin-bottom: 1rem;
  }

  .blog-content :global(a) {
    color: #b8892e;
    text-decoration: underline;
  }

  .blog-content :global(a:hover) {
    color: #9a6e24;
  }

  .blog-content :global(blockquote) {
    border-left: 2px solid #d97706;
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: #6b7280;
    font-style: italic;
  }

  .blog-content :global(code) {
    background: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .blog-content :global(pre) {
    background: #1f2937;
    color: #e5e7eb;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .blog-content :global(pre code) {
    background: none;
    padding: 0;
    color: inherit;
  }

  .blog-content :global(ul),
  .blog-content :global(ol) {
    padding-left: 1.25rem;
    margin-bottom: 1rem;
    font-size: 0.9375rem;
    line-height: 1.75;
    color: #374151;
  }

  .blog-content :global(ul) {
    list-style-type: disc;
  }

  .blog-content :global(ol) {
    list-style-type: decimal;
  }

  .blog-content :global(li) {
    margin-bottom: 0.25rem;
  }

  .blog-content :global(img) {
    max-width: 100%;
    border-radius: 0.375rem;
    margin: 1.5rem 0;
  }

  .blog-content :global(hr) {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 2rem 0;
  }
</style>
